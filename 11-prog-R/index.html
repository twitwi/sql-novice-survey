<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2017-01-30 00:04:11 +0100">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="/swc-releases/1999.12/sql-novice-survey">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Databases and SQL: Programming with Databases - R</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li><a href="../reference/">Reference</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-select/">Selecting Data</a></li>
            
            <li><a href="../02-sort-dup/">Sorting and Removing Duplicates</a></li>
            
            <li><a href="../03-filter/">Filtering</a></li>
            
            <li><a href="../04-calc/">Calculating New Values</a></li>
            
            <li><a href="../05-null/">Missing Data</a></li>
            
            <li><a href="../06-agg/">Aggregation</a></li>
            
            <li><a href="../07-join/">Combining Data</a></li>
            
            <li><a href="../08-hygiene/">Data Hygiene</a></li>
            
            <li><a href="../09-create/">Creating and Modifying Data</a></li>
            
            <li><a href="../10-prog/">Programming with Databases - Python</a></li>
            
            <li><a href="../11-prog-R/">Programming with Databases - R</a></li>
            
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../about/">About</a></li>
            
            <li><a href="../discuss/">Discussion</a></li>
            
            <li><a href="../figures/">Figures</a></li>
            
            <li><a href="../guide/">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../10-prog/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">Databases and SQL</a></h3>
    <h1 class="maintitle">Programming with Databases - R</h1>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 30 min
      <br/>
      <strong>Exercises:</strong> 15 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How can I access databases from programs written in R?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Write short programs that execute SQL queries.</p>
</li>
	
	<li><p>Trace the execution of a program that contains an SQL query.</p>
</li>
	
	<li><p>Explain why most database applications are written in a general-purpose language rather than in SQL.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>To close,
let’s have a look at how to access a database from
a data analysis language like R.
Other languages use almost exactly the same model:
library and function names may differ,
but the concepts are the same.</p>

<p>Here’s a short R program that selects latitudes and longitudes
from an SQLite database stored in a file called <code class="highlighter-rouge">survey.db</code>:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>library(RSQLite)
connection &lt;- dbConnect(SQLite(), "survey.db")
results &lt;- dbGetQuery(connection, "SELECT Site.lat, Site.long FROM Site;")
print(results)
dbDisconnect(connection)
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>     lat    long
1 -49.85 -128.57
2 -47.15 -126.72
3 -48.87 -123.40
</code></pre>
</div>

<p>The program starts by importing the <code class="highlighter-rouge">RSQLite</code> library.
If we were connecting to MySQL, DB2, or some other database,
we would import a different library,
but all of them provide the same functions,
so that the rest of our program does not have to change
(at least, not much)
if we switch from one database to another.</p>

<p>Line 2 establishes a connection to the database.
Since we’re using SQLite,
all we need to specify is the name of the database file.
Other systems may require us to provide a username and password as well.</p>

<p>On line 3, we retrieve the results from an SQL query.
It’s our job to make sure that SQL is properly formatted;
if it isn’t,
or if something goes wrong when it is being executed,
the database will report an error.
This result is a dataframe with one row for each entry and one column for each column in the database.</p>

<p>Finally, the last line closes our connection,
since the database can only keep a limited number of these open at one time.
Since establishing a connection takes time,
though,
we shouldn’t open a connection,
do one operation,
then close the connection,
only to reopen it a few microseconds later to do another operation.
Instead,
it’s normal to create one connection that stays open for the lifetime of the program.</p>

<p>Queries in real applications will often depend on values provided by users.
For example,
this function takes a user’s ID as a parameter and returns their name:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>library(RSQLite)

connection &lt;- dbConnect(SQLite(), "survey.db")

getName &lt;- function(personID) {
  query &lt;- paste0("SELECT personal || ' ' || family FROM Person WHERE ident =='",
                  personID, "';")
  return(dbGetQuery(connection, query))
}

print(paste("full name for dyer:", getName('dyer')))

dbDisconnect(connection)
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>full name for dyer: William Dyer
</code></pre>
</div>

<p>We use string concatenation on the first line of this function
to construct a query containing the user ID we have been given.
This seems simple enough,
but what happens if someone gives us this string as input?</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>dyer'; DROP TABLE Survey; SELECT '
</code></pre>
</div>

<p>It looks like there’s garbage after the user’s ID,
but it is very carefully chosen garbage.
If we insert this string into our query,
the result is:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT personal || ' ' || family FROM Person WHERE id='dyer'; DROP TABLE Survey; SELECT '';
</code></pre>
</div>

<p>If we execute this,
it will erase one of the tables in our database.</p>

<p>This is called an <a href="reference.html#sql-injection-attack">SQL injection attack</a>,
and it has been used to attack thousands of programs over the years.
In particular,
many web sites that take data from users insert values directly into queries
without checking them carefully first.
A very <a href="https://xkcd.com/327/">relevant XKCD</a> that explains the 
dangers of using raw input in queries a little more succinctly:</p>

<p><img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" alt="relevant XKCD" /></p>

<p>Since an unscrupulous parent might try to smuggle commands into our queries in many different ways,
the safest way to deal with this threat is
to replace characters like quotes with their escaped equivalents,
so that we can safely put whatever the user gives us inside a string.
We can do this by using a <a href="reference.html#prepared-statement">prepared statement</a>
instead of formatting our statements as strings.
Here’s what our example program looks like if we do this:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>library(RSQLite)
connection &lt;- dbConnect(SQLite(), "survey.db")

getName &lt;- function(personID) {
  query &lt;- "SELECT personal || ' ' || family FROM Person WHERE ident == ?"
  return(dbGetPreparedQuery(connection, query, data.frame(personID)))
}

print(paste("full name for dyer:", getName('dyer')))

dbDisconnect(connection)
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>full name for dyer: William Dyer
</code></pre>
</div>

<p>The key changes are in the query string and the <code class="highlighter-rouge">dbGetQuery</code> call (we use dbGetPreparedQuery instead).
Instead of formatting the query ourselves,
we put question marks in the query template where we want to insert values.
When we call <code class="highlighter-rouge">dbGetPreparedQuery</code>,
we provide a dataframe
that contains as many values as there are question marks in the query.
The library matches values to question marks in order,
and translates any special characters in the values
into their escaped equivalents
so that they are safe to use.</p>

<blockquote class="challenge">
  <h2 id="filling-a-table-vs-printing-values">Filling a Table vs. Printing Values</h2>

  <p>Write an R program that creates a new database in a file called
<code class="highlighter-rouge">original.db</code> containing a single table called <code class="highlighter-rouge">Pressure</code>, with a
single field called <code class="highlighter-rouge">reading</code>, and inserts 100,000 random numbers
between 10.0 and 25.0.  How long does it take this program to run?
How long does it take to run a program that simply writes those
random numbers to a file?</p>
</blockquote>

<blockquote class="challenge">
  <h2 id="filtering-in-sql-vs-filtering-in-r">Filtering in SQL vs. Filtering in R</h2>

  <p>Write an R program that creates a new database called
<code class="highlighter-rouge">backup.db</code> with the same structure as <code class="highlighter-rouge">original.db</code> and copies all
the values greater than 20.0 from <code class="highlighter-rouge">original.db</code> to <code class="highlighter-rouge">backup.db</code>.
Which is faster: filtering values in the query, or reading
everything into memory and filtering in R?</p>
</blockquote>

<h2 id="database-helper-functions-in-r">Database helper functions in R</h2>

<p>R’s database interface packages (like <code class="highlighter-rouge">RSQLite</code>) all share 
a common set of helper functions useful for exploring databases and 
reading/writing entire tables at once.</p>

<p>To view all tables in a database, we can use <code class="highlighter-rouge">dbListTables()</code>:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>connection &lt;- dbConnect(SQLite(), "survey.db")
dbListTables(connection)
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>"Person"  "Site"    "Survey"  "Visited"
</code></pre>
</div>

<p>To view all column names of a table, use <code class="highlighter-rouge">dbListFields()</code>:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>dbListFields(connection, "Survey")
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>"taken"   "person"  "quant"   "reading"
</code></pre>
</div>

<p>To read an entire table as a dataframe, use <code class="highlighter-rouge">dbReadTable()</code>:</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>dbReadTable(connection, "Person")
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>     ident  personal   family
1     dyer   William     Dyer
2       pb     Frank  Pabodie
3     lake  Anderson     Lake
4      roe Valentina  Roerich
5 danforth     Frank Danforth
</code></pre>
</div>

<p>Finally to write an entire table to a database, you can use <code class="highlighter-rouge">dbWriteTable()</code>. 
Note that we will always want to use the <code class="highlighter-rouge">row.names = FALSE</code> argument or R 
will write the row names as a separate column. 
In this example we will write R’s built-in <code class="highlighter-rouge">iris</code> dataset as a table in <code class="highlighter-rouge">survey.db</code>.</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>dbWriteTable(connection, "iris", iris, row.names = FALSE)
head(dbReadTable(connection, "iris"))
</code></pre>
</div>
<div class="output highlighter-rouge"><pre class="highlight"><code>  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
1          5.1         3.5          1.4         0.2  setosa
2          4.9         3.0          1.4         0.2  setosa
3          4.7         3.2          1.3         0.2  setosa
4          4.6         3.1          1.5         0.2  setosa
5          5.0         3.6          1.4         0.2  setosa
6          5.4         3.9          1.7         0.4  setosa
</code></pre>
</div>

<p>And as always, remember to close the database connection when done!</p>

<div class="r highlighter-rouge"><pre class="highlight"><code>dbDisconnect(connection)
</code></pre>
</div>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Data analysis languages have libraries for accessing databases.</p>
</li>
    
    <li><p>To connect to a database, a program must use a library specific to that database manager.</p>
</li>
    
    <li><p>R’s libraries can be used to directly query or read from a database.</p>
</li>
    
    <li><p>Programs can read query results in batches or all at once.</p>
</li>
    
    <li><p>Queries should be written using parameter substitution, not string formatting.</p>
</li>
    
    <li><p>R has multiple helper functions to make working with databases easier.</p>
</li>
    
  </ul>
</blockquote>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../10-prog/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


      
      <footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016
	<a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="mailto:lessons@software-carpentry.org">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    <script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
